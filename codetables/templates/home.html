{% extends 'base.html' %}

{% block content %}

<style type="text/css">
#container
{
    width: 40px;
    float: left;
    color: Gray;
    font-family: Courier New;
    font-size: 14px;
    overflow: hidden;
    height: 400px;
    position: relative;
}
#divlines 
{
    position: absolute;
}
#code_text 
{
    overflow-x: scroll;
    height: 400px;
    font-family: Courier New;
    font-size: 14px;
}
</style>
<div class ="col-md-8">
<form class="form-signin">
	{% csrf_token %}
	<h2 class="form-signin-heading" align="center">C code</h2>
        
	<div id="container">
		<div id="divlines">
		</div>
	</div>
	<textarea id="code_text" cols="100" wrap="off"  name="code_text">
#include <stdio.h>
int main()
{
    printf("Hello World!\n");
    return 0;
}</textarea>
	<div id='checkbox'>
		<label><input id="user_input" type="checkbox" onclick="take_user_input()" name="check_uncheck">Give input for the test</label>	
		<div id="user_input">
			<textarea rows='4' cols='40' name="user_input_value" id= "user_input_value"></textarea>
		</div>
	</div>
	<input type="button" value="Compile and run" onclick="compile_and_run()" class="btn btn-lg btn-primary btn-block">

	<input type="button" onclick="new_file()" class="btn bt-lg btn-primary btn-block" value="Save">
</form>

 	
</div>
<div class ='col-md-4'>
	<div id="code_error_output" style="visibility:hidden;margin-top:20px;background-color:#F0F0F0;width:90%;padding:20px;border-radius:10px" ></div>
</div>
	<script type="text/javascript">
	var lines = document.getElementById("divlines");
	var txtArea = document.getElementById("code_text");
	window.onload = function() {
	    refreshlines();
	    txtArea.onscroll = function () {
	        lines.style.top = -(txtArea.scrollTop) + "px";
	        return true;
	    }
	    txtArea.onkeyup = function () {
	        refreshlines();
	        return true;
	    }
	    txtArea.onkeydown = function(e){
	    	if(e.keyCode==9 || e.which==9){
	    	            e.preventDefault();
	    	            var s = this.selectionStart;
	    	            this.value = this.value.substring(0,this.selectionStart) + "\t" + this.value.substring(this.selectionEnd);
	    	            this.selectionEnd = s+1; 
	    }		
	}
}

	function refreshlines() {
	    var nLines = txtArea.value.split("\n").length;
	    lines.innerHTML = ""
	    for (i=1; i<=nLines; i++) {
	        lines.innerHTML = lines.innerHTML + i + "." + "<br />";
	    }
	    lines.style.top = -(txtArea.scrollTop) + "px";

	}
    function compile_and_run(){
    		var code_text = document.getElementById("code_text").value;
    		var user_input_check = document.getElementById("user_input").checked;
    		var user_input_value;
    		if(user_input_check)
    		{
    			user_input_value = document.getElementById("user_input_value").value;
    		}
    		var postForm = {
    			'code_text': code_text,
    			'user_input_value': user_input_value,
    			'check_uncheck': user_input_check,
    			csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value
    		}
    		$.ajax({
    			url: '/compile/',
    			type: 'POST',
    			data: postForm,
    			success: function(d) {
    				d = JSON.parse(d);
    		    	
    		    	create_output_or_error_div(d['output_code'], d['error_code'], d['time_taken'], d['compile_status'])
    	    	},
    	    	failure: function(d) { 	
    	    		alert('hi');
    	    	}
    		});}
    function create_output_or_error_div(output_code, error_code, time_taken, compile_status)
    {
    	var myNode = document.getElementById('code_error_output');
    	while (myNode.firstChild) {
    	    myNode.removeChild(myNode.firstChild);
    	}
		myNode.style.visibility = 'visible';
		if (compile_status != '')
    	{
    		r=document.createElement('textarea');
    		r.id='compile_status';
    		r.rows='3';
    		r.cols='40';
    		r.value = compile_status;
    		r.style.backgroundColor = 'red';
    		r.style.color='white';
    		r.style.borderRadius='5px';
    		
			document.getElementById('code_error_output').appendChild(r);	
    	}
    	else
    	{
    		r=document.createElement('textarea');
    		r.id='compile_status';
    		r.rows='3';
    		r.cols='40';
    		r.value = "Successful";
    		r.style.backgroundColor = 'green';
    		r.style.color='white';
    		r.style.borderRadius='5px';    		
    		document.getElementById('code_error_output').appendChild(r);	
    		if(output_code != '')
    		{
    			r=document.createElement('textarea');
    			r.id='output_code';
    			r.rows='3';
    			r.cols='40';
    			r.value = output_code;
    			r.style.backgroundColor = 'orange';
    			r.style.color='white';
    			r.style.borderRadius='5px';    		
    			document.getElementById('code_error_output').appendChild(r);    			
    		}
    		if(error_code != '')
    		{
    			r=document.createElement('textarea');
    			r.id='error_code';
    			r.rows='3';
    			r.cols='40';
    			r.value = error_code;
    			r.style.backgroundColor = 'red';
    			r.style.color='white';
    			r.style.borderRadius='5px';    		
    			document.getElementById('code_error_output').appendChild(r);    		
    		}
    			r=document.createElement('div');
    			r.id='time_taken';
    			r.innerHTML = time_taken;
    			document.getElementById('code_error_output').appendChild(r);   

    	}
    }	
    function new_file(){
    	var code_text = document.getElementById("code_text").value;
    	var title = prompt("Please enter title to your file", "BubbleSorting");
    	var postForm = {
    		'code_text': code_text,
    		'title':title,
    		csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value
    	}
    	$.ajax({
    		url: '/save_file/',
    		type: 'POST',
    		data: postForm,
    		success: function(d) {
    			d= JSON.parse(d);
    			var confirm_check;
    			if(d['1'] == '3')
    			{
    				confirm_check = confirm('The file with same name exsist and if you wanna work on that code press OK')
    				if(confirm_check)
    				   	document.getElementById("code_text").value = d['2'];
    			}	
    			else
    				alert(d['2']);
    		},	
        	failure: function(d) { 	
        		alert('Ajax failed');
        	}
    	});}	
	</script>
{% endblock %}